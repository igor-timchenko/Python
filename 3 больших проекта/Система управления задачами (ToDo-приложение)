"""
–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∞–º–∏ (ToDo-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)
–ê–≤—Ç–æ—Ä: –¢–∏–º—á–µ–Ω–∫–æ –ò–≥–æ—Ä—å –í–∞—Å–∏–ª—å–µ–≤–∏—á
"""
import tkinter as tk
from tkinter import ttk, messagebox, filedialog
import sqlite3
import json
from datetime import datetime, timedelta
import calendar
from tkcalendar import Calendar
import matplotlib.pyplot as plt
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg
import os
import csv
import smtplib
from email.mime.text import MimeText
import hashlib
import base64
from cryptography.fernet import Fernet
import threading
import time

class DatabaseManager:
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö SQLite"""
    
    def __init__(self, db_name='tasks.db'):
        self.db_name = db_name
        self.init_database()
    
    def init_database(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
        conn = sqlite3.connect(self.db_name)
        cursor = conn.cursor()
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∑–∞–¥–∞—á
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS tasks (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                title TEXT NOT NULL,
                description TEXT,
                priority TEXT DEFAULT 'medium',
                status TEXT DEFAULT 'pending',
                created_date TEXT,
                due_date TEXT,
                completed_date TEXT,
                category TEXT DEFAULT 'general',
                tags TEXT,
                estimated_time INTEGER DEFAULT 0,
                actual_time INTEGER DEFAULT 0,
                reminder_date TEXT,
                is_recurring INTEGER DEFAULT 0,
                recurrence_pattern TEXT,
                parent_task_id INTEGER,
                project_id INTEGER,
                assigned_to TEXT,
                progress INTEGER DEFAULT 0
            )
        ''')
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–æ–µ–∫—Ç–æ–≤
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS projects (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL,
                description TEXT,
                start_date TEXT,
                end_date TEXT,
                status TEXT DEFAULT 'active',
                progress INTEGER DEFAULT 0
            )
        ''')
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS users (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                username TEXT UNIQUE NOT NULL,
                password TEXT NOT NULL,
                email TEXT,
                created_date TEXT
            )
        ''')
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS settings (
                id INTEGER PRIMARY KEY,
                theme TEXT DEFAULT 'light',
                language TEXT DEFAULT 'ru',
                auto_save INTEGER DEFAULT 1,
                notifications INTEGER DEFAULT 1,
                backup_interval INTEGER DEFAULT 30,
                default_priority TEXT DEFAULT 'medium'
            )
        ''')
        
        # –í—Å—Ç–∞–≤–∫–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
        cursor.execute("SELECT COUNT(*) FROM settings")
        if cursor.fetchone()[0] == 0:
            cursor.execute('''
                INSERT INTO settings (id, theme, language, auto_save, notifications, backup_interval, default_priority)
                VALUES (1, 'light', 'ru', 1, 1, 30, 'medium')
            ''')
        
        conn.commit()
        conn.close()
    
    def execute_query(self, query, params=None):
        """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL-–∑–∞–ø—Ä–æ—Å–∞"""
        conn = sqlite3.connect(self.db_name)
        cursor = conn.cursor()
        if params:
            cursor.execute(query, params)
        else:
            cursor.execute(query)
        conn.commit()
        conn.close()
    
    def fetch_all(self, query, params=None):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"""
        conn = sqlite3.connect(self.db_name)
        cursor = conn.cursor()
        if params:
            cursor.execute(query, params)
        else:
            cursor.execute(query)
        results = cursor.fetchall()
        conn.close()
        return results
    
    def fetch_one(self, query, params=None):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞"""
        conn = sqlite3.connect(self.db_name)
        cursor = conn.cursor()
        if params:
            cursor.execute(query, params)
        else:
            cursor.execute(query)
        result = cursor.fetchone()
        conn.close()
        return result

class Task:
    """–ö–ª–∞—Å—Å –∑–∞–¥–∞—á–∏"""
    
    def __init__(self, title, description="", priority="medium", 
                 due_date=None, category="general", tags=None, 
                 estimated_time=0, project_id=None, assigned_to=None):
        self.id = None
        self.title = title
        self.description = description
        self.priority = priority
        self.status = "pending"
        self.created_date = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        self.due_date = due_date
        self.completed_date = None
        self.category = category
        self.tags = tags or []
        self.estimated_time = estimated_time
        self.actual_time = 0
        self.reminder_date = None
        self.is_recurring = False
        self.recurrence_pattern = None
        self.parent_task_id = None
        self.project_id = project_id
        self.assigned_to = assigned_to
        self.progress = 0
        self.subtasks = []
    
    def add_subtask(self, subtask):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–∑–∞–¥–∞—á–∏"""
        self.subtasks.append(subtask)
    
    def complete(self):
        """–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏"""
        self.status = "completed"
        self.completed_date = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        self.progress = 100
    
    def to_dict(self):
        """–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ —Å–ª–æ–≤–∞—Ä—å"""
        return {
            'id': self.id,
            'title': self.title,
            'description': self.description,
            'priority': self.priority,
            'status': self.status,
            'created_date': self.created_date,
            'due_date': self.due_date,
            'completed_date': self.completed_date,
            'category': self.category,
            'tags': json.dumps(self.tags),
            'estimated_time': self.estimated_time,
            'actual_time': self.actual_time,
            'reminder_date': self.reminder_date,
            'is_recurring': int(self.is_recurring),
            'recurrence_pattern': self.recurrence_pattern,
            'parent_task_id': self.parent_task_id,
            'project_id': self.project_id,
            'assigned_to': self.assigned_to,
            'progress': self.progress
        }

class Project:
    """–ö–ª–∞—Å—Å –ø—Ä–æ–µ–∫—Ç–∞"""
    
    def __init__(self, name, description="", start_date=None, end_date=None):
        self.id = None
        self.name = name
        self.description = description
        self.start_date = start_date or datetime.now().strftime("%Y-%m-%d")
        self.end_date = end_date
        self.status = "active"
        self.progress = 0
        self.tasks = []
    
    def add_task(self, task):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≤ –ø—Ä–æ–µ–∫—Ç"""
        self.tasks.append(task)
        task.project_id = self.id
    
    def update_progress(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø—Ä–æ–µ–∫—Ç–∞"""
        if self.tasks:
            completed_tasks = sum(1 for task in self.tasks if task.status == "completed")
            self.progress = int((completed_tasks / len(self.tasks)) * 100)
        else:
            self.progress = 0

class SettingsManager:
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏"""
    
    def __init__(self, db_manager):
        self.db_manager = db_manager
        self.settings = self.load_settings()
    
    def load_settings(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫"""
        result = self.db_manager.fetch_one("SELECT * FROM settings WHERE id = 1")
        if result:
            return {
                'theme': result[1],
                'language': result[2],
                'auto_save': bool(result[3]),
                'notifications': bool(result[4]),
                'backup_interval': result[5],
                'default_priority': result[6]
            }
        return {
            'theme': 'light',
            'language': 'ru',
            'auto_save': True,
            'notifications': True,
            'backup_interval': 30,
            'default_priority': 'medium'
        }
    
    def save_settings(self):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫"""
        query = '''
            UPDATE settings SET 
            theme = ?, language = ?, auto_save = ?, 
            notifications = ?, backup_interval = ?, default_priority = ?
            WHERE id = 1
        '''
        params = (
            self.settings['theme'],
            self.settings['language'],
            int(self.settings['auto_save']),
            int(self.settings['notifications']),
            self.settings['backup_interval'],
            self.settings['default_priority']
        )
        self.db_manager.execute_query(query, params)

class AnalyticsEngine:
    """–î–≤–∏–∂–æ–∫ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏"""
    
    def __init__(self, db_manager):
        self.db_manager = db_manager
    
    def get_task_statistics(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞–¥–∞—á"""
        stats = {}
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
        results = self.db_manager.fetch_all("SELECT status, COUNT(*) FROM tasks GROUP BY status")
        stats['status'] = dict(results)
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º
        results = self.db_manager.fetch_all("SELECT priority, COUNT(*) FROM tasks GROUP BY priority")
        stats['priority'] = dict(results)
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        results = self.db_manager.fetch_all("SELECT category, COUNT(*) FROM tasks GROUP BY category")
        stats['category'] = dict(results)
        
        # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á
        result = self.db_manager.fetch_one("SELECT COUNT(*) FROM tasks")
        stats['total'] = result[0] if result else 0
        
        # –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
        result = self.db_manager.fetch_one("SELECT COUNT(*) FROM tasks WHERE status = 'completed'")
        stats['completed'] = result[0] if result else 0
        
        return stats
    
    def get_productivity_report(self, start_date=None, end_date=None):
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –æ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏"""
        if not start_date:
            start_date = (datetime.now() - timedelta(days=30)).strftime("%Y-%m-%d")
        if not end_date:
            end_date = datetime.now().strftime("%Y-%m-%d")
        
        # –ó–∞–¥–∞—á–∏, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –≤ –ø–µ—Ä–∏–æ–¥–µ
        result = self.db_manager.fetch_one("""
            SELECT COUNT(*) FROM tasks 
            WHERE created_date BETWEEN ? AND ?
        """, (start_date, end_date + " 23:59:59"))
        created_count = result[0] if result else 0
        
        # –ó–∞–¥–∞—á–∏, –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –≤ –ø–µ—Ä–∏–æ–¥–µ
        result = self.db_manager.fetch_one("""
            SELECT COUNT(*) FROM tasks 
            WHERE completed_date BETWEEN ? AND ?
        """, (start_date, end_date + " 23:59:59"))
        completed_count = result[0] if result else 0
        
        return {
            'created': created_count,
            'completed': completed_count,
            'completion_rate': (completed_count / max(created_count, 1)) * 100
        }

class BackupManager:
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–º –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
    
    def __init__(self, db_path='tasks.db'):
        self.db_path = db_path
        self.backup_dir = 'backups'
        os.makedirs(self.backup_dir, exist_ok=True)
    
    def create_backup(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏"""
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        backup_filename = f"tasks_backup_{timestamp}.db"
        backup_path = os.path.join(self.backup_dir, backup_filename)
        
        try:
            import shutil
            shutil.copy2(self.db_path, backup_path)
            return backup_path
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏: {e}")
            return None
    
    def restore_backup(self, backup_path):
        """–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏"""
        try:
            import shutil
            shutil.copy2(backup_path, self.db_path)
            return True
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: {e}")
            return False

class TaskListFrame(ttk.Frame):
    """–§—Ä–µ–π–º —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á"""
    
    def __init__(self, parent, task_manager):
        super().__init__(parent)
        self.task_manager = task_manager
        self.create_widgets()
        self.refresh_tasks()
    
    def create_widgets(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–æ–≤"""
        # –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤
        filter_frame = ttk.Frame(self)
        filter_frame.pack(fill='x', padx=10, pady=5)
        
        ttk.Label(filter_frame, text="–§–∏–ª—å—Ç—Ä:").pack(side='left', padx=5)
        
        self.status_var = tk.StringVar(value="all")
        status_combo = ttk.Combobox(filter_frame, textvariable=self.status_var,
                                   values=["all", "pending", "in_progress", "completed"])
        status_combo.pack(side='left', padx=5)
        status_combo.bind('<<ComboboxSelected>>', lambda e: self.refresh_tasks())
        
        self.priority_var = tk.StringVar(value="all")
        priority_combo = ttk.Combobox(filter_frame, textvariable=self.priority_var,
                                     values=["all", "low", "medium", "high", "urgent"])
        priority_combo.pack(side='left', padx=5)
        priority_combo.bind('<<ComboboxSelected>>', lambda e: self.refresh_tasks())
        
        ttk.Button(filter_frame, text="–û–±–Ω–æ–≤–∏—Ç—å", 
                  command=self.refresh_tasks).pack(side='right', padx=5)
        
        # –¢–∞–±–ª–∏—Ü–∞ –∑–∞–¥–∞—á
        columns = ('ID', '–ù–∞–∑–≤–∞–Ω–∏–µ', '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç', '–°—Ç–∞—Ç—É—Å', '–°—Ä–æ–∫', '–ö–∞—Ç–µ–≥–æ—Ä–∏—è', '–ü—Ä–æ–≥—Ä–µ—Å—Å')
        self.tree = ttk.Treeview(self, columns=columns, show='headings', height=15)
        
        for col in columns:
            self.tree.heading(col, text=col)
            self.tree.column(col, width=100)
        
        # –°–∫—Ä–æ–ª–ª–±–∞—Ä—ã
        v_scrollbar = ttk.Scrollbar(self, orient='vertical', command=self.tree.yview)
        h_scrollbar = ttk.Scrollbar(self, orient='horizontal', command=self.tree.xview)
        self.tree.configure(yscrollcommand=v_scrollbar.set, xscrollcommand=h_scrollbar.set)
        
        # –†–∞–∑–º–µ—â–µ–Ω–∏–µ
        self.tree.pack(side='left', fill='both', expand=True, padx=10, pady=5)
        v_scrollbar.pack(side='right', fill='y')
        h_scrollbar.pack(side='bottom', fill='x')
        
        # –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        button_frame = ttk.Frame(self)
        button_frame.pack(fill='x', padx=10, pady=5)
        
        ttk.Button(button_frame, text="–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É", 
                  command=self.add_task).pack(side='left', padx=5)
        ttk.Button(button_frame, text="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", 
                  command=self.edit_task).pack(side='left', padx=5)
        ttk.Button(button_frame, text="–£–¥–∞–ª–∏—Ç—å", 
                  command=self.delete_task).pack(side='left', padx=5)
        ttk.Button(button_frame, text="–ó–∞–≤–µ—Ä—à–∏—Ç—å", 
                  command=self.complete_task).pack(side='left', padx=5)
        ttk.Button(button_frame, text="–≠–∫—Å–ø–æ—Ä—Ç", 
                  command=self.export_tasks).pack(side='right', padx=5)
        
        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞
        self.tree.bind('<Double-1>', self.edit_task)
    
    def refresh_tasks(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á"""
        # –û—á–∏—Å—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
        for item in self.tree.get_children():
            self.tree.delete(item)
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        status_filter = self.status_var.get()
        priority_filter = self.priority_var.get()
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
        query = "SELECT * FROM tasks WHERE 1=1"
        params = []
        
        if status_filter != "all":
            query += " AND status = ?"
            params.append(status_filter)
        
        if priority_filter != "all":
            query += " AND priority = ?"
            params.append(priority_filter)
        
        query += " ORDER BY created_date DESC"
        
        tasks = self.task_manager.db_manager.fetch_all(query, params)
        
        for task in tasks:
            progress = f"{task[19]}%" if task[19] else "0%"
            values = (task[0], task[1][:30], task[3], task[4], 
                     task[6] or '', task[8], progress)
            self.tree.insert('', 'end', values=values, tags=(task[0],))
    
    def add_task(self):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏"""
        dialog = TaskDialog(self, self.task_manager)
        self.refresh_tasks()
    
    def edit_task(self, event=None):
        """–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏"""
        selection = self.tree.selection()
        if not selection:
            messagebox.showwarning("–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ", "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")
            return
        
        item = self.tree.item(selection[0])
        task_id = item['tags'][0]
        
        dialog = TaskDialog(self, self.task_manager, task_id)
        self.refresh_tasks()
    
    def delete_task(self):
        """–£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏"""
        selection = self.tree.selection()
        if not selection:
            messagebox.showwarning("–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ", "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è")
            return
        
        if messagebox.askyesno("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ", "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?"):
            item = self.tree.item(selection[0])
            task_id = item['tags'][0]
            
            self.task_manager.db_manager.execute_query(
                "DELETE FROM tasks WHERE id = ?", (task_id,)
            )
            self.refresh_tasks()
    
    def complete_task(self):
        """–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏"""
        selection = self.tree.selection()
        if not selection:
            messagebox.showwarning("–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ", "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è")
            return
        
        item = self.tree.item(selection[0])
        task_id = item['tags'][0]
        
        self.task_manager.db_manager.execute_query(
            "UPDATE tasks SET status = 'completed', completed_date = ?, progress = 100 WHERE id = ?",
            (datetime.now().strftime("%Y-%m-%d %H:%M:%S"), task_id)
        )
        self.refresh_tasks()
    
    def export_tasks(self):
        """–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–¥–∞—á –≤ CSV"""
        filename = filedialog.asksaveasfilename(
            defaultextension=".csv",
            filetypes=[("CSV files", "*.csv"), ("All files", "*.*")]
        )
        
        if filename:
            try:
                tasks = self.task_manager.db_manager.fetch_all(
                    "SELECT * FROM tasks ORDER BY created_date DESC"
                )
                
                with open(filename, 'w', newline='', encoding='utf-8') as csvfile:
                    writer = csv.writer(csvfile)
                    writer.writerow(['ID', '–ù–∞–∑–≤–∞–Ω–∏–µ', '–û–ø–∏—Å–∞–Ω–∏–µ', '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç', '–°—Ç–∞—Ç—É—Å',
                                   '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è', '–°—Ä–æ–∫', '–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è', '–ö–∞—Ç–µ–≥–æ—Ä–∏—è'])
                    
                    for task in tasks:
                        writer.writerow([
                            task[0], task[1], task[2], task[3], task[4],
                            task[5], task[6], task[7], task[8]
                        ])
                
                messagebox.showinfo("–£—Å–ø–µ—Ö", "–ó–∞–¥–∞—á–∏ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã")
            except Exception as e:
                messagebox.showerror("–û—à–∏–±–∫–∞", f"–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: {str(e)}")

class TaskDialog:
    """–î–∏–∞–ª–æ–≥–æ–≤–æ–µ –æ–∫–Ω–æ –∑–∞–¥–∞—á–∏"""
    
    def __init__(self, parent, task_manager, task_id=None):
        self.parent = parent
        self.task_manager = task_manager
        self.task_id = task_id
        
        self.window = tk.Toplevel(parent)
        self.window.title("–ó–∞–¥–∞—á–∞" if not task_id else "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É")
        self.window.geometry("500x600")
        self.window.transient(parent)
        self.window.grab_set()
        
        self.create_widgets()
        if task_id:
            self.load_task_data()
        
        self.window.wait_window()
    
    def create_widgets(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–æ–≤"""
        # –û—Å–Ω–æ–≤–Ω–∞—è —Ä–∞–º–∫–∞
        main_frame = ttk.Frame(self.window, padding="10")
        main_frame.pack(fill='both', expand=True)
        
        # –ù–∞–∑–≤–∞–Ω–∏–µ
        ttk.Label(main_frame, text="–ù–∞–∑–≤–∞–Ω–∏–µ:").grid(row=0, column=0, sticky='w', pady=5)
        self.title_var = tk.StringVar()
        self.title_entry = ttk.Entry(main_frame, textvariable=self.title_var, width=40)
        self.title_entry.grid(row=0, column=1, pady=5, padx=5)
        
        # –û–ø–∏—Å–∞–Ω–∏–µ
        ttk.Label(main_frame, text="–û–ø–∏—Å–∞–Ω–∏–µ:").grid(row=1, column=0, sticky='nw', pady=5)
        self.description_var = tk.StringVar()
        self.description_text = tk.Text(main_frame, width=40, height=5)
        self.description_text.grid(row=1, column=1, pady=5, padx=5)
        
        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç
        ttk.Label(main_frame, text="–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:").grid(row=2, column=0, sticky='w', pady=5)
        self.priority_var = tk.StringVar(value="medium")
        priority_combo = ttk.Combobox(main_frame, textvariable=self.priority_var,
                                     values=["low", "medium", "high", "urgent"], width=37)
        priority_combo.grid(row=2, column=1, pady=5, padx=5)
        
        # –ö–∞—Ç–µ–≥–æ—Ä–∏—è
        ttk.Label(main_frame, text="–ö–∞—Ç–µ–≥–æ—Ä–∏—è:").grid(row=3, column=0, sticky='w', pady=5)
        self.category_var = tk.StringVar(value="general")
        categories = ["general", "work", "personal", "shopping", "health", "education"]
        category_combo = ttk.Combobox(main_frame, textvariable=self.category_var,
                                     values=categories, width=37)
        category_combo.grid(row=3, column=1, pady=5, padx=5)
        
        # –°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        ttk.Label(main_frame, text="–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:").grid(row=4, column=0, sticky='w', pady=5)
        self.due_date_var = tk.StringVar()
        self.due_date_entry = ttk.Entry(main_frame, textvariable=self.due_date_var, width=30)
        self.due_date_entry.grid(row=4, column=1, pady=5, padx=5)
        
        # –ö–Ω–æ–ø–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        ttk.Button(main_frame, text="üìÖ", width=3,
                  command=self.show_calendar).grid(row=4, column=2, pady=5, padx=2)
        
        # –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ (—á–∞—Å—ã)
        ttk.Label(main_frame, text="–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ (—á–∞—Å—ã):").grid(row=5, column=0, sticky='w', pady=5)
        self.estimated_time_var = tk.IntVar()
        time_spinbox = ttk.Spinbox(main_frame, from_=0, to=1000, 
                                  textvariable=self.estimated_time_var, width=37)
        time_spinbox.grid(row=5, column=1, pady=5, padx=5)
        
        # –ü—Ä–æ–≥—Ä–µ—Å—Å
        ttk.Label(main_frame, text="–ü—Ä–æ–≥—Ä–µ—Å—Å (%):").grid(row=6, column=0, sticky='w', pady=5)
        self.progress_var = tk.IntVar()
        progress_spinbox = ttk.Spinbox(main_frame, from_=0, to=100, 
                                      textvariable=self.progress_var, width=37)
        progress_spinbox.grid(row=6, column=1, pady=5, padx=5)
        
        # –¢–µ–≥–∏
        ttk.Label(main_frame, text="–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):").grid(row=7, column=0, sticky='w', pady=5)
        self.tags_var = tk.StringVar()
        self.tags_entry = ttk.Entry(main_frame, textvariable=self.tags_var, width=40)
        self.tags_entry.grid(row=7, column=1, pady=5, padx=5)
        
        # –ö–Ω–æ–ø–∫–∏
        button_frame = ttk.Frame(main_frame)
        button_frame.grid(row=8, column=0, columnspan=3, pady=20)
        
        ttk.Button(button_frame, text="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", 
                  command=self.save_task).pack(side='left', padx=5)
        ttk.Button(button_frame, text="–û—Ç–º–µ–Ω–∞", 
                  command=self.window.destroy).pack(side='left', padx=5)
    
    def show_calendar(self):
        """–ü–æ–∫–∞–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã"""
        def on_date_select():
            selected_date = cal.get_date()
            self.due_date_var.set(selected_date)
            calendar_window.destroy()
        
        calendar_window = tk.Toplevel(self.window)
        calendar_window.title("–í—ã–±–æ—Ä –¥–∞—Ç—ã")
        calendar_window.geometry("300x300")
        calendar_window.transient(self.window)
        calendar_window.grab_set()
        
        cal = Calendar(calendar_window, selectmode='day', 
                      year=datetime.now().year,
                      month=datetime.now().month,
                      day=datetime.now().day)
        cal.pack(pady=20)
        
        ttk.Button(calendar_window, text="–í—ã–±—Ä–∞—Ç—å", 
                  command=on_date_select).pack(pady=10)
    
    def load_task_data(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
        task = self.task_manager.db_manager.fetch_one(
            "SELECT * FROM tasks WHERE id = ?", (self.task_id,)
        )
        
        if task:
            self.title_var.set(task[1])
            self.description_text.insert('1.0', task[2] or '')
            self.priority_var.set(task[3])
            self.category_var.set(task[8])
            self.due_date_var.set(task[6] or '')
            self.estimated_time_var.set(task[10] or 0)
            self.progress_var.set(task[19] or 0)
            if task[9]:  # tags
                try:
                    tags = json.loads(task[9])
                    self.tags_var.set(', '.join(tags))
                except:
                    self.tags_var.set(task[9] or '')
    
    def save_task(self):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏"""
        title = self.title_var.get().strip()
        if not title:
            messagebox.showerror("–û—à–∏–±–∫–∞", "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏")
            return
        
        description = self.description_text.get('1.0', 'end').strip()
        tags_str = self.tags_var.get().strip()
        tags = [tag.strip() for tag in tags_str.split(',') if tag.strip()] if tags_str else []
        
        if self.task_id:  # –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞–¥–∞—á–∏
            query = '''
                UPDATE tasks SET 
                title = ?, description = ?, priority = ?, category = ?,
                due_date = ?, estimated_time = ?, progress = ?, tags = ?
                WHERE id = ?
            '''
            params = (
                title, description, self.priority_var.get(), self.category_var.get(),
                self.due_date_var.get() or None, self.estimated_time_var.get(),
                self.progress_var.get(), json.dumps(tags), self.task_id
            )
        else:  # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏
            query = '''
                INSERT INTO tasks 
                (title, description, priority, status, created_date, due_date, 
                 category, tags, estimated_time, progress)
                VALUES (?, ?, ?, 'pending', ?, ?, ?, ?, ?, ?)
            '''
            params = (
                title, description, self.priority_var.get(),
                datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                self.due_date_var.get() or None, self.category_var.get(),
                json.dumps(tags), self.estimated_time_var.get(), self.progress_var.get()
            )
        
        try:
            self.task_manager.db_manager.execute_query(query, params)
            messagebox.showinfo("–£—Å–ø–µ—Ö", "–ó–∞–¥–∞—á–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞")
            self.window.destroy()
        except Exception as e:
            messagebox.showerror("–û—à–∏–±–∫–∞", f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: {str(e)}")

class AnalyticsFrame(ttk.Frame):
    """–§—Ä–µ–π–º –∞–Ω–∞–ª–∏—Ç–∏–∫–∏"""
    
    def __init__(self, parent, task_manager):
        super().__init__(parent)
        self.task_manager = task_manager
        self.analytics_engine = AnalyticsEngine(task_manager.db_manager)
        self.create_widgets()
        self.update_analytics()
    
    def create_widgets(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–æ–≤"""
        # –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å
        top_frame = ttk.Frame(self)
        top_frame.pack(fill='x', padx=10, pady=5)
        
        ttk.Button(top_frame, text="–û–±–Ω–æ–≤–∏—Ç—å", 
                  command=self.update_analytics).pack(side='right')
        
        # –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å
        self.notebook = ttk.Notebook(self)
        self.notebook.pack(fill='both', expand=True, padx=10, pady=5)
        
        # –í–∫–ª–∞–¥–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        self.stats_frame = ttk.Frame(self.notebook)
        self.notebook.add(self.stats_frame, text="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
        
        # –í–∫–ª–∞–¥–∫–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤
        self.charts_frame = ttk.Frame(self.notebook)
        self.notebook.add(self.charts_frame, text="–ì—Ä–∞—Ñ–∏–∫–∏")
        
        # –í–∫–ª–∞–¥–∫–∞ –æ—Ç—á–µ—Ç–æ–≤
        self.reports_frame = ttk.Frame(self.notebook)
        self.notebook.add(self.reports_frame, text="–û—Ç—á–µ—Ç—ã")
    
    def update_analytics(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏"""
        self.update_statistics()
        self.update_charts()
        self.update_reports()
    
    def update_statistics(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
        # –û—á–∏—Å—Ç–∫–∞ —Ñ—Ä–µ–π–º–∞
        for widget in self.stats_frame.winfo_children():
            widget.destroy()
        
        stats = self.analytics_engine.get_task_statistics()
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ç–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        row = 0
        ttk.Label(self.stats_frame, text="–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", 
                 font=('Arial', 12, 'bold')).grid(row=row, column=0, columnspan=2, pady=10)
        row += 1
        
        ttk.Label(self.stats_frame, text="–í—Å–µ–≥–æ –∑–∞–¥–∞—á:").grid(row=row, column=0, sticky='w', padx=10)
        ttk.Label(self.stats_frame, text=str(stats.get('total', 0))).grid(row=row, column=1, sticky='w')
        row += 1
        
        ttk.Label(self.stats_frame, text="–ó–∞–≤–µ—Ä—à–µ–Ω–æ:").grid(row=row, column=0, sticky='w', padx=10)
        ttk.Label(self.stats_frame, text=str(stats.get('completed', 0))).grid(row=row, column=1, sticky='w')
        row += 1
        
        completion_rate = (stats.get('completed', 0) / max(stats.get('total', 1), 1)) * 100
        ttk.Label(self.stats_frame, text="–ü—Ä–æ—Ü–µ–Ω—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:").grid(row=row, column=0, sticky='w', padx=10)
        ttk.Label(self.stats_frame, text=f"{completion_rate:.1f}%").grid(row=row, column=1, sticky='w')
        row += 1
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
        ttk.Label(self.stats_frame, text="–ü–æ —Å—Ç–∞—Ç—É—Å–∞–º", 
                 font=('Arial', 12, 'bold')).grid(row=row, column=0, columnspan=2, pady=10)
        row += 1
        
        for status, count in stats.get('status', {}).items():
            ttk.Label(self.stats_frame, text=f"{status}:").grid(row=row, column=0, sticky='w', padx=10)
            ttk.Label(self.stats_frame, text=str(count)).grid(row=row, column=1, sticky='w')
            row += 1
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º
        ttk.Label(self.stats_frame, text="–ü–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º", 
                 font=('Arial', 12, 'bold')).grid(row=row, column=0, columnspan=2, pady=10)
        row += 1
        
        for priority, count in stats.get('priority', {}).items():
            ttk.Label(self.stats_frame, text=f"{priority}:").grid(row=row, column=0, sticky='w', padx=10)
            ttk.Label(self.stats_frame, text=str(count)).grid(row=row, column=1, sticky='w')
            row += 1
    
    def update_charts(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤"""
        # –û—á–∏—Å—Ç–∫–∞ —Ñ—Ä–µ–π–º–∞
        for widget in self.charts_frame.winfo_children():
            widget.destroy()
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∏–≥—É—Ä—ã matplotlib
        fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(12, 5))
        
        # –ì—Ä–∞—Ñ–∏–∫ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
        stats = self.analytics_engine.get_task_statistics()
        status_data = stats.get('status', {})
        if status_data:
            ax1.pie(status_data.values(), labels=status_data.keys(), autopct='%1.1f%%')
            ax1.set_title('–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º')
        
        # –ì—Ä–∞—Ñ–∏–∫ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º
        priority_data = stats.get('priority', {})
        if priority_data:
            ax2.bar(priority_data.keys(), priority_data.values())
            ax2.set_title('–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º')
            ax2.set_ylabel('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ')
        
        # –í—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –≤ Tkinter
        canvas = FigureCanvasTkAgg(fig, self.charts_frame)
        canvas.draw()
        canvas.get_tk_widget().pack(fill='both', expand=True)
    
    def update_reports(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤"""
        # –û—á–∏—Å—Ç–∫–∞ —Ñ—Ä–µ–π–º–∞
        for widget in self.reports_frame.winfo_children():
            widget.destroy()
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
        report = self.analytics_engine.get_productivity_report()
        
        ttk.Label(self.reports_frame, text="–û—Ç—á–µ—Ç –æ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏", 
                 font=('Arial', 12, 'bold')).pack(pady=10)
        
        ttk.Label(self.reports_frame, 
                 text=f"–°–æ–∑–¥–∞–Ω–æ –∑–∞–¥–∞—á: {report['created']}").pack(anchor='w', padx=20)
        ttk.Label(self.reports_frame, 
                 text=f"–ó–∞–≤–µ—Ä—à–µ–Ω–æ –∑–∞–¥–∞—á: {report['completed']}").pack(anchor='w', padx=20)
        ttk.Label(self.reports_frame, 
                 text=f"–ü—Ä–æ—Ü–µ–Ω—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: {report['completion_rate']:.1f}%").pack(anchor='w', padx=20)

class SettingsFrame(ttk.Frame):
    """–§—Ä–µ–π–º –Ω–∞—Å—Ç—Ä–æ–µ–∫"""
    
    def __init__(self, parent, task_manager):
        super().__init__(parent)
        self.task_manager = task_manager
        self.settings_manager = task_manager.settings_manager
        self.create_widgets()
        self.load_settings()
    
    def create_widgets(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–æ–≤"""
        # –û—Å–Ω–æ–≤–Ω–∞—è —Ä–∞–º–∫–∞
        main_frame = ttk.Frame(self, padding="20")
        main_frame.pack(fill='both', expand=True)
        
        ttk.Label(main_frame, text="–ù–∞—Å—Ç—Ä–æ–π–∫–∏", 
                 font=('Arial', 14, 'bold')).pack(pady=10)
        
        # –¢–µ–º–∞
        theme_frame = ttk.Frame(main_frame)
        theme_frame.pack(fill='x', pady=5)
        
        ttk.Label(theme_frame, text="–¢–µ–º–∞:").pack(side='left')
        self.theme_var = tk.StringVar()
        theme_combo = ttk.Combobox(theme_frame, textvariable=self.theme_var,
                                  values=["light", "dark"], width=20)
        theme_combo.pack(side='left', padx=10)
        
        # –Ø–∑—ã–∫
        language_frame = ttk.Frame(main_frame)
        language_frame.pack(fill='x', pady=5)
        
        ttk.Label(language_frame, text="–Ø–∑—ã–∫:").pack(side='left')
        self.language_var = tk.StringVar()
        language_combo = ttk.Combobox(language_frame, textvariable=self.language_var,
                                     values=["ru", "en"], width=20)
        language_combo.pack(side='left', padx=10)
        
        # –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        autosave_frame = ttk.Frame(main_frame)
        autosave_frame.pack(fill='x', pady=5)
        
        ttk.Label(autosave_frame, text="–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:").pack(side='left')
        self.autosave_var = tk.BooleanVar()
        autosave_check = ttk.Checkbutton(autosave_frame, variable=self.autosave_var)
        autosave_check.pack(side='left', padx=10)
        
        # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        notifications_frame = ttk.Frame(main_frame)
        notifications_frame.pack(fill='x', pady=5)
        
        ttk.Label(notifications_frame, text="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:").pack(side='left')
        self.notifications_var = tk.BooleanVar()
        notifications_check = ttk.Checkbutton(notifications_frame, variable=self.notifications_var)
        notifications_check.pack(side='left', padx=10)
        
        # –ò–Ω—Ç–µ—Ä–≤–∞–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
        backup_frame = ttk.Frame(main_frame)
        backup_frame.pack(fill='x', pady=5)
        
        ttk.Label(backup_frame, text="–ò–Ω—Ç–µ—Ä–≤–∞–ª –±—ç–∫–∞–ø–∞ (–º–∏–Ω):").pack(side='left')
        self.backup_interval_var = tk.IntVar()
        backup_spinbox = ttk.Spinbox(backup_frame, from_=1, to=1440, 
                                    textvariable=self.backup_interval_var, width=18)
        backup_spinbox.pack(side='left', padx=10)
        
        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        priority_frame = ttk.Frame(main_frame)
        priority_frame.pack(fill='x', pady=5)
        
        ttk.Label(priority_frame, text="–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:").pack(side='left')
        self.default_priority_var = tk.StringVar()
        priority_combo = ttk.Combobox(priority_frame, textvariable=self.default_priority_var,
                                     values=["low", "medium", "high", "urgent"], width=18)
        priority_combo.pack(side='left', padx=10)
        
        # –ö–Ω–æ–ø–∫–∏
        button_frame = ttk.Frame(main_frame)
        button_frame.pack(fill='x', pady=20)
        
        ttk.Button(button_frame, text="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", 
                  command=self.save_settings).pack(side='left', padx=5)
        ttk.Button(button_frame, text="–°–±—Ä–æ—Å–∏—Ç—å", 
                  command=self.load_settings).pack(side='left', padx=5)
        ttk.Button(button_frame, text="–°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø", 
                  command=self.create_backup).pack(side='right', padx=5)
    
    def load_settings(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫"""
        settings = self.settings_manager.settings
        self.theme_var.set(settings['theme'])
        self.language_var.set(settings['language'])
        self.autosave_var.set(settings['auto_save'])
        self.notifications_var.set(settings['notifications'])
        self.backup_interval_var.set(settings['backup_interval'])
        self.default_priority_var.set(settings['default_priority'])
    
    def save_settings(self):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫"""
        self.settings_manager.settings.update({
            'theme': self.theme_var.get(),
            'language': self.language_var.get(),
            'auto_save': self.autosave_var.get(),
            'notifications': self.notifications_var.get(),
            'backup_interval': self.backup_interval_var.get(),
            'default_priority': self.default_priority_var.get()
        })
        self.settings_manager.save_settings()
        messagebox.showinfo("–£—Å–ø–µ—Ö", "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã")
    
    def create_backup(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏"""
        backup_manager = BackupManager()
        backup_path = backup_manager.create_backup()
        if backup_path:
            messagebox.showinfo("–£—Å–ø–µ—Ö", f"–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞: {backup_path}")
        else:
            messagebox.showerror("–û—à–∏–±–∫–∞", "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é")

class TaskManagerApp:
    """–û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"""
    
    def __init__(self):
        self.root = tk.Tk()
        self.root.title("Task Manager Pro")
        self.root.geometry("1000x700")
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        self.db_manager = DatabaseManager()
        self.settings_manager = SettingsManager(self.db_manager)
        self.backup_manager = BackupManager()
        
        self.create_menu()
        self.create_notebook()
        self.setup_auto_backup()
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–º—ã
        self.apply_theme()
    
    def create_menu(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –º–µ–Ω—é"""
        menubar = tk.Menu(self.root)
        self.root.config(menu=menubar)
        
        # –ú–µ–Ω—é —Ñ–∞–π–ª
        file_menu = tk.Menu(menubar, tearoff=0)
        menubar.add_cascade(label="–§–∞–π–ª", menu=file_menu)
        file_menu.add_command(label="–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–¥–∞—á", command=self.export_tasks)
        file_menu.add_command(label="–ò–º–ø–æ—Ä—Ç –∑–∞–¥–∞—á", command=self.import_tasks)
        file_menu.add_separator()
        file_menu.add_command(label="–í—ã—Ö–æ–¥", command=self.root.quit)
        
        # –ú–µ–Ω—é –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
        tools_menu = tk.Menu(menubar, tearoff=0)
        menubar.add_cascade(label="–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã", menu=tools_menu)
        tools_menu.add_command(label="–°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø", command=self.create_backup)
        tools_menu.add_command(label="–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±—ç–∫–∞–ø", command=self.restore_backup)
        tools_menu.add_separator()
        tools_menu.add_command(label="–û—á–∏—Å—Ç–∏—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏", command=self.clear_completed)
    
    def create_notebook(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫"""
        self.notebook = ttk.Notebook(self.root)
        self.notebook.pack(fill='both', expand=True, padx=5, pady=5)
        
        # –í–∫–ª–∞–¥–∫–∞ –∑–∞–¥–∞—á
        self.tasks_frame = TaskListFrame(self.notebook, self)
        self.notebook.add(self.tasks_frame, text="–ó–∞–¥–∞—á–∏")
        
        # –í–∫–ª–∞–¥–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
        self.analytics_frame = AnalyticsFrame(self.notebook, self)
        self.notebook.add(self.analytics_frame, text="–ê–Ω–∞–ª–∏—Ç–∏–∫–∞")
        
        # –í–∫–ª–∞–¥–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        self.settings_frame = SettingsFrame(self.notebook, self)
        self.notebook.add(self.settings_frame, text="–ù–∞—Å—Ç—Ä–æ–π–∫–∏")
    
    def setup_auto_backup(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è"""
        def backup_worker():
            while True:
                interval = self.settings_manager.settings['backup_interval']
                time.sleep(interval * 60)  # –ü–µ—Ä–µ–≤–æ–¥–∏–º –º–∏–Ω—É—Ç—ã –≤ —Å–µ–∫—É–Ω–¥—ã
                if self.settings_manager.settings['auto_save']:
                    self.backup_manager.create_backup()
        
        backup_thread = threading.Thread(target=backup_worker, daemon=True)
        backup_thread.start()
    
    def apply_theme(self):
        """–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã"""
        theme = self.settings_manager.settings['theme']
        if theme == 'dark':
            style = ttk.Style()
            style.theme_use('clam')
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
        else:
            style = ttk.Style()
            style.theme_use('default')
    
    def export_tasks(self):
        """–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–¥–∞—á"""
        self.tasks_frame.export_tasks()
    
    def import_tasks(self):
        """–ò–º–ø–æ—Ä—Ç –∑–∞–¥–∞—á"""
        filename = filedialog.askopenfilename(
            filetypes=[("CSV files", "*.csv"), ("All files", "*.*")]
        )
        
        if filename:
            try:
                with open(filename, 'r', encoding='utf-8') as csvfile:
                    reader = csv.reader(csvfile)
                    next(reader)  # –ü—Ä–æ–ø—É—Å–∫ –∑–∞–≥–æ–ª–æ–≤–∫–∞
                    
                    for row in reader:
                        if len(row) >= 9:
                            query = '''
                                INSERT INTO tasks 
                                (title, description, priority, status, created_date, 
                                 due_date, completed_date, category)
                                VALUES (?, ?, ?, ?, ?, ?, ?, ?)
                            '''
                            params = tuple(row[1:9])
                            self.db_manager.execute_query(query, params)
                
                messagebox.showinfo("–£—Å–ø–µ—Ö", "–ó–∞–¥–∞—á–∏ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã")
                self.tasks_frame.refresh_tasks()
            except Exception as e:
                messagebox.showerror("–û—à–∏–±–∫–∞", f"–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: {str(e)}")
    
    def create_backup(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏"""
        backup_path = self.backup_manager.create_backup()
        if backup_path:
            messagebox.showinfo("–£—Å–ø–µ—Ö", f"–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞: {backup_path}")
        else:
            messagebox.showerror("–û—à–∏–±–∫–∞", "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é")
    
    def restore_backup(self):
        """–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏"""
        filename = filedialog.askopenfilename(
            initialdir="backups",
            filetypes=[("Database files", "*.db"), ("All files", "*.*")]
        )
        
        if filename:
            if messagebox.askyesno("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ", 
                                 "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ? –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã."):
                if self.backup_manager.restore_backup(filename):
                    messagebox.showinfo("–£—Å–ø–µ—Ö", "–î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã")
                    self.tasks_frame.refresh_tasks()
                else:
                    messagebox.showerror("–û—à–∏–±–∫–∞", "–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ")
    
    def clear_completed(self):
        """–û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á"""
        if messagebox.askyesno("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ", "–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏?"):
            self.db_manager.execute_query("DELETE FROM tasks WHERE status = 'completed'")
            self.tasks_frame.refresh_tasks()
            messagebox.showinfo("–£—Å–ø–µ—Ö", "–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ —É–¥–∞–ª–µ–Ω—ã")
    
    def run(self):
        """–ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
        self.root.mainloop()

def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    try:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫
        import tkcalendar
        import matplotlib
        import cryptography
    except ImportError as e:
        print(f"–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏: {e}")
        print("pip install tkcalendar matplotlib cryptography")
        return
    
    app = TaskManagerApp()
    app.run()

if __name__ == "__main__":
    main()
